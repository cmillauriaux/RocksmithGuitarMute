name: Build and Release

on:
  push:
    branches: [ master ]

permissions:
  contents: write
  packages: write

jobs:
  build-windows:
    runs-on: windows-2022
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        cache: 'pip'
    
    - name: Install system dependencies
      run: |
        # Install Visual C++ Redistributable - direct download method
        Write-Host "Installing Visual C++ Redistributable..."
        $url = "https://aka.ms/vs/17/release/vc_redist.x64.exe"
        $output = "$env:TEMP\vc_redist.x64.exe"
        Write-Host "Downloading from: $url"
        Invoke-WebRequest -Uri $url -OutFile $output
        Write-Host "Installing Visual C++ Redistributable..."
        Start-Process -FilePath $output -ArgumentList "/quiet" -Wait
        Write-Host "Cleaning up..."
        Remove-Item $output
        Write-Host "Visual C++ Redistributable installation completed."
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        # Install compatible versions for CI environment
        # Use newer compatible versions since 2.0.x are no longer available
        pip install numpy==1.26.4  # Use a version available in binary wheels
        pip install torch==2.2.0+cpu torchaudio==2.2.0+cpu --extra-index-url https://download.pytorch.org/whl/cpu
        pip install PyInstaller
        # Install project dependencies in development mode first
        pip install -e rsrtools/
        # Install Demucs with relaxed version constraints
        cd demucs && pip install -e . --no-deps && cd ..
        # Manually install Demucs dependencies with compatible versions
        pip install einops julius>=0.2.3 lameenc openunmix pyyaml torchaudio>=2.2.0
        pip install dora-search
        # Install additional critical dependencies
        pip install diffq omegaconf hydra-core>=1.1.0
        # Install remaining requirements
        pip install soundfile>=0.12.0 cffi>=1.0
    
    - name: Verify dependencies and fix NumPy
      run: |
        Write-Host "Verifying and fixing dependencies..."
        $env:PYTHONIOENCODING = "utf-8"
        python -c "
        import sys, os
        os.environ['PYTHONIOENCODING'] = 'utf-8'
        print(f'Python executable: {sys.executable}')
        
        # Test numpy import
        try:
            import numpy as np
            print(f'OK NumPy version: {np.__version__}')
            # Test the problematic import
            import numpy.core.multiarray
            print('OK numpy.core.multiarray: working')
        except ImportError as e:
            print(f'ERROR NumPy import failed: {e}')
        
        # Test torch
        try:
            import torch
            print(f'OK PyTorch version: {torch.__version__}')
            print(f'CUDA available: {torch.cuda.is_available()}')
        except ImportError as e:
            print(f'ERROR PyTorch import failed: {e}')
        
        # Test torchaudio
        try:
            import torchaudio
            print(f'OK TorchAudio version: {torchaudio.__version__}')
        except ImportError as e:
            print(f'ERROR TorchAudio import failed: {e}')
        
        # Test demucs with more detailed error reporting
        try:
            import demucs
            print(f'OK Demucs version: {demucs.__version__}')
        except Exception as e:
            print(f'ERROR Demucs test failed: {e}')
        
        # Test soundfile
        try:
            import soundfile
            print(f'OK SoundFile version: {soundfile.__version__}')
        except ImportError as e:
            print(f'ERROR SoundFile import failed: {e}')
        
        print('OK Dependency verification completed')
        "
    
    - name: Download Demucs models
      run: |
        Write-Host "Downloading essential Demucs models..."
        $env:PYTHONIOENCODING = "utf-8"
        python -c "
        import sys, os
        os.environ['PYTHONIOENCODING'] = 'utf-8'
        try:
            import demucs.pretrained
            
            # Creer le dossier de cache s'il n'existe pas
            cache_dir = os.path.expanduser('~/.cache/torch/hub/checkpoints')
            os.makedirs(cache_dir, exist_ok=True)
            print(f'Cache directory: {cache_dir}')
            
            # Telecharger le modele principal (htdemucs_6s fonctionne selon les logs)
            try:
                print('Downloading htdemucs_6s model...')
                model = demucs.pretrained.get_model('htdemucs_6s')
                print('OK htdemucs_6s model downloaded and loaded successfully')
            except Exception as e:
                print(f'ERROR Failed to download htdemucs_6s: {e}')
                
            print('Model download completed')
        except Exception as e:
            print(f'ERROR Model download failed: {e}')
            import traceback
            traceback.print_exc()
        "
        Write-Host "Demucs models download completed"
    
    - name: Clean build directories
      run: |
        cd build
        python build_windows.py --clean-only
    
    - name: Build executable
      run: |
        cd build
        python build_windows.py --onefile --optimize
      env:
        GITHUB_ACTIONS: 'true'
    
    - name: Verify build output
      run: |
        if (Test-Path "build/dist/RockSmithGuitarMute.exe") {
          Write-Host "Build successful - executable found"
          $size = (Get-Item "build/dist/RockSmithGuitarMute.exe").Length / 1MB
          Write-Host "Executable size: $([math]::Round($size, 1)) MB"
        } else {
          Write-Host "Build failed - executable not found"
          Write-Host "Contents of build/dist/:"
          if (Test-Path "build/dist") {
            Get-ChildItem -Recurse "build/dist" | ForEach-Object { Write-Host "  $($_.FullName)" }
          }
          exit 1
        }
    
    - name: Test executable functionality
      run: |
        Write-Host "Testing executable functionality..."
        cd build/dist
        
        # Test 1: Basic executable analysis
        Write-Host "Test 1: Executable analysis"
        $exeSize = (Get-Item ".\RockSmithGuitarMute.exe").Length / 1MB
        Write-Host "Executable size: $([math]::Round($exeSize, 1)) MB"
        
        if ($exeSize -gt 200) {
            Write-Host "OK Executable size suggests all dependencies are included"
        } elseif ($exeSize -gt 100) {
            Write-Host "WARNING Executable size acceptable but may be missing some dependencies"
        } else {
            Write-Host "ERROR Executable size too small - likely missing critical dependencies"
        }
        
        # Test 2: Run our dedicated test script
        Write-Host "`nTest 2: Running import tests"
        Copy-Item "..\test_executable.py" "test_executable.py"
        
        try {
            python test_executable.py
            if ($LASTEXITCODE -eq 0) {
                Write-Host "OK Import test passed"
            } else {
                Write-Host "WARNING Import test had warnings (exit code: $LASTEXITCODE)"
            }
        } catch {
            Write-Host "ERROR Import test failed: $($_.Exception.Message)"
        }
        
        # Test 3: Strings analysis for critical components
        Write-Host "`nTest 3: Critical components check"
        try {
            $patterns = @("numpy", "torch", "demucs", "htdemucs_6s", "python")
            $foundComponents = @()
            
            foreach ($pattern in $patterns) {
                $found = Select-String -Path ".\RockSmithGuitarMute.exe" -Pattern $pattern -Quiet
                if ($found) {
                    $foundComponents += $pattern
                }
            }
            
            Write-Host "Found components: $($foundComponents -join ', ')"
            if ($foundComponents.Count -ge 3) {
                Write-Host "OK Critical components found in executable"
            } else {
                Write-Host "WARNING Some critical components may be missing"
            }
        } catch {
            Write-Host "WARNING Could not analyze executable strings"
        }
        
        Write-Host "`nExecutable testing completed"
    
    - name: Create release archive
      run: |
        cd build/dist
        # Create a zip file with all distribution files
        Compress-Archive -Path * -DestinationPath "../../RockSmithGuitarMute-Windows.zip"
        cd ../..
        Write-Host "Archive created: RockSmithGuitarMute-Windows.zip"
        $archiveSize = (Get-Item "RockSmithGuitarMute-Windows.zip").Length / 1MB
        Write-Host "Archive size: $([math]::Round($archiveSize, 1)) MB"
    
    - name: Generate release tag
      id: tag
      run: |
        $timestamp = Get-Date -Format "yyyy-MM-dd-HHmm"
        $shortSha = "${{ github.sha }}".Substring(0, 7)
        $tag = "v$timestamp-$shortSha"
        echo "tag=$tag" >> $env:GITHUB_OUTPUT
        echo "Generated tag: $tag"
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag.outputs.tag }}
        name: "RockSmith Guitar Mute ${{ steps.tag.outputs.tag }}"
        body: |
          Automatic release from commit ${{ github.sha }}
          
          ## Changes
          - Built from latest master branch
          - Commit: ${{ github.sha }}
          - Build date: ${{ github.event.head_commit.timestamp }}
          
          ## Installation
          1. Download `RockSmithGuitarMute-Windows.zip`
          2. Extract the archive
          3. Run `install.bat` as administrator for system installation
          4. Or run `RockSmithGuitarMute.exe` directly
          
          ## System Requirements
          - Windows 10/11 (64-bit)
          - 8 GB RAM minimum (16 GB recommended)
          - 2 GB free disk space
          - Multi-core processor recommended
          - NVIDIA GPU with CUDA support (optional, for acceleration)
        files: |
          RockSmithGuitarMute-Windows.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: RockSmithGuitarMute-Windows
        path: |
          build/dist/
          RockSmithGuitarMute-Windows.zip
        retention-days: 30
