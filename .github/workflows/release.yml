name: Build and Release

on:
  push:
    branches: [ master ]
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  actions: read

jobs:
  build-windows:
    runs-on: windows-2022
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Verify system dependencies
      run: |
        # Check if Visual C++ Redistributable is available (usually pre-installed on GitHub runners)
        echo "Checking system dependencies..."
        python -c "import sys; print('Python version:', sys.version)"
        echo "System ready for PyTorch installation"
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        # Install specific versions to match local environment
        pip install torch==2.8.0 torchaudio==2.8.0 --index-url https://download.pytorch.org/whl/cpu
        pip install -r requirements.txt
        pip install pyinstaller>=5.0.0
    
    - name: Verify dependencies
      run: |
        python -c "import torch; print('PyTorch version:', torch.__version__)"
        python -c "import demucs; print('Demucs installed successfully')"
        python -c "import soundfile; print('SoundFile installed successfully')"
        python -c "import tkinter; print('Tkinter available')"
    
    - name: Build Windows executable
      run: |
        REM Set UTF-8 encoding for Python to handle Unicode characters
        set PYTHONIOENCODING=utf-8
        cd build
        python build_windows.py --onefile --no-optimize
      shell: cmd
      continue-on-error: true
    
    - name: Check build logs
      run: |
        Write-Host "=== Checking for build logs ==="
        if (Test-Path "build/build.log") {
          Write-Host "Build log found:"
          Get-Content "build/build.log" -Tail 50
        }
        if (Test-Path "build/*.log") {
          Write-Host "Other log files found:"
          Get-ChildItem "build/*.log" | ForEach-Object {
            Write-Host "--- $($_.Name) ---"
            Get-Content $_.FullName -Tail 20
          }
        }
        Write-Host "=== End of logs ==="
      shell: powershell
      continue-on-error: true
    
    - name: Debug build output
      run: |
        Write-Host "=== Build Output Debug ==="
        Write-Host "Current directory: $(Get-Location)"
        Write-Host ""
        Write-Host "Contents of current directory:"
        Get-ChildItem -Force | Format-Table Name, Length, LastWriteTime
        Write-Host ""
        if (Test-Path "dist") {
          Write-Host "Contents of dist directory:"
          Get-ChildItem "dist" -Force | Format-Table Name, Length, LastWriteTime
        } else {
          Write-Host "dist directory does not exist"
        }
        Write-Host ""
        if (Test-Path "build") {
          Write-Host "Contents of build directory:"
          Get-ChildItem "build" -Force | Format-Table Name, Length, LastWriteTime
          Write-Host ""
          if (Test-Path "build/dist") {
            Write-Host "Contents of build/dist directory:"
            Get-ChildItem "build/dist" -Force | Format-Table Name, Length, LastWriteTime
          } else {
            Write-Host "build/dist directory does not exist"
          }
        } else {
          Write-Host "build directory does not exist"
        }
      shell: powershell
    
    - name: Verify build output
      run: |
        # Check in build/dist directory (where PyInstaller creates the executable)
        if (Test-Path "build/dist/RockSmithGuitarMute.exe") {
          Write-Host "Executable built successfully in build/dist/"
          $size = (Get-Item "build/dist/RockSmithGuitarMute.exe").Length / 1MB
          Write-Host "Size: $([math]::Round($size, 2)) MB"
          
          # Verify executable size (should be around 300+ MB for complete build)
          if ($size -lt 200) {
            Write-Host "WARNING: Executable size is suspiciously small ($([math]::Round($size, 2)) MB)"
            Write-Host "Expected size: ~300+ MB. Build may be incomplete."
            Write-Host "This could indicate missing PyTorch libraries or other dependencies."
          } else {
            Write-Host "Executable size looks good ($([math]::Round($size, 2)) MB)"
          }
          
          # Move executable to root dist directory for consistency
          if (-not (Test-Path "dist")) {
            New-Item -ItemType Directory -Path "dist"
          }
          Copy-Item "build/dist/RockSmithGuitarMute.exe" "dist/"
          Write-Host "Executable copied to dist/ directory"
        } else {
          Write-Host "Executable not found in build/dist/"
          Write-Host "Checking build/dist contents:"
          if (Test-Path "build/dist") {
            Get-ChildItem "build/dist" -Force | Format-Table Name, Length, LastWriteTime
          } else {
            Write-Host "build/dist directory does not exist"
          }
          
          Write-Host "Searching for executable in all directories..."
          $exeFiles = Get-ChildItem -Recurse -Name "*.exe" -ErrorAction SilentlyContinue
          if ($exeFiles) {
            Write-Host "Found .exe files:"
            $exeFiles | ForEach-Object { Write-Host "  $_" }
          } else {
            Write-Host "No .exe files found anywhere"
          }
          exit 1
        }
      shell: powershell
    
    - name: Create Windows distribution package
      run: |
        # Create distribution directory
        New-Item -ItemType Directory -Force -Path "release-windows"
        
        # Copy executable
        Copy-Item "dist/RockSmithGuitarMute.exe" "release-windows/"
        
        # Copy additional files if they exist
        if (Test-Path "dist/install.bat") { Copy-Item "dist/install.bat" "release-windows/" }
        if (Test-Path "dist/README.txt") { Copy-Item "dist/README.txt" "release-windows/" }
        
        # Copy essential project files
        Copy-Item "README.md" "release-windows/"
        Copy-Item "CONTRIBUTING.md" "release-windows/" -ErrorAction SilentlyContinue
        
        # Create a simple launcher script
        @"
        @echo off
        echo Starting RockSmith Guitar Mute...
        echo.
        RockSmithGuitarMute.exe
        if errorlevel 1 (
            echo.
            echo An error occurred. Press any key to exit.
            pause >nul
        )
        "@ | Out-File -FilePath "release-windows/launch.bat" -Encoding ASCII
        
        Write-Host "Windows distribution package created"
      shell: powershell
    
    - name: Upload Windows build artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-executable
        path: release-windows/
        retention-days: 30

  create-source-package:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive
    
    - name: Create source distribution
      run: |
        # Create source package directory
        mkdir -p release-source
        
        # Copy all source files except build artifacts and cache
        rsync -av --exclude='.git' \
                  --exclude='__pycache__' \
                  --exclude='*.pyc' \
                  --exclude='build/' \
                  --exclude='dist/' \
                  --exclude='*.egg-info' \
                  --exclude='output/' \
                  --exclude='test_output*/' \
                  --exclude='.pytest_cache' \
                  --exclude='*.log' \
                  . release-source/
        
        echo "Source distribution created"
    
    - name: Upload source artifact
      uses: actions/upload-artifact@v4
      with:
        name: source-code
        path: release-source/
        retention-days: 30

  create-release:
    needs: [build-windows, create-source-package]
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Download Windows build
      uses: actions/download-artifact@v4
      with:
        name: windows-executable
        path: windows-build/
    
    - name: Download source code
      uses: actions/download-artifact@v4
      with:
        name: source-code
        path: source-build/
    
    - name: Generate version and release info
      id: version
      run: |
        # Generate version based on date and commit
        VERSION="v$(date +'%Y.%m.%d')-$(git rev-parse --short HEAD)"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
        # Generate release notes
        cat > release_notes.md << 'EOF'
        ## 🎸 RockSmith Guitar Mute Release
        
        ### What's New
        - Automatic build from latest master branch
        - AI-powered guitar track removal using Demucs
        - Support for Rocksmith 2014 PSARC files
        - Graphical user interface for easy operation
        
        ### 📦 Downloads
        - **Windows Executable**: `RockSmithGuitarMute-windows.zip` - Ready-to-run application for Windows
        - **Source Code**: `RockSmithGuitarMute-source.zip` - Complete source code for all platforms
        
        ### 🖥️ System Requirements (Windows)
        - Windows 10/11 (64-bit)
        - 8 GB RAM minimum (16 GB recommended)
        - 2 GB free disk space
        - Multi-core processor recommended
        - NVIDIA GPU with CUDA support (optional, for acceleration)
        
        ### 🚀 Quick Start
        1. Download `RockSmithGuitarMute-windows.zip`
        2. Extract to a folder of your choice
        3. Run `RockSmithGuitarMute.exe`
        4. Select your PSARC files and output directory
        5. Click "Start Processing"
        
        ### 🔧 Advanced Usage
        For developers or users who want to run from source:
        1. Download `RockSmithGuitarMute-source.zip`
        2. Install Python 3.8+ and dependencies: `pip install -r requirements.txt`
        3. Run: `python gui/gui_main.py`
        
        ### 📝 Notes
        - First run may take longer as AI models are downloaded
        - GPU acceleration requires NVIDIA GPU with CUDA support
        - Processing time varies based on song length and hardware
        
        Built from commit: `${{ github.sha }}`
        EOF
        
        echo "Generated version: $VERSION"
    
    - name: Create ZIP packages
      run: |
        # Create Windows ZIP
        cd windows-build
        zip -r ../RockSmithGuitarMute-windows.zip .
        cd ..
        
        # Create Source ZIP  
        cd source-build
        zip -r ../RockSmithGuitarMute-source.zip .
        cd ..
        
        # Verify packages
        ls -lh *.zip
        echo "Release packages created"
        
        # Verify both ZIP files exist
        if [ ! -f "RockSmithGuitarMute-windows.zip" ]; then
          echo "ERROR: Windows ZIP package not found"
          exit 1
        fi
        
        if [ ! -f "RockSmithGuitarMute-source.zip" ]; then
          echo "ERROR: Source ZIP package not found"
          exit 1
        fi
        
        echo "Both ZIP packages verified successfully"
    
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: "RockSmith Guitar Mute ${{ steps.version.outputs.version }}"
        body_path: release_notes.md
        draft: false
        prerelease: false
        files: |
          RockSmithGuitarMute-windows.zip
          RockSmithGuitarMute-source.zip
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Update latest release info
      run: |
        echo "Release ${{ steps.version.outputs.version }} created successfully!"
        echo "Windows executable and source code are now available for download."
        echo "Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"
